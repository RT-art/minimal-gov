<div align="center">

# Minimal Gov

</div>

**AWS Ã— Terraform Ã— Terragrunt**

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€å®Ÿå‹™ã§è§¦ã‚Œã¦ã„ãŸç’°å¢ƒã‚’å¯èƒ½ãªé™ã‚Šæ¨¡å€£ã—ã€å€‹äººãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã¨ã—ã¦æ§‹ç¯‰ã—ãŸ **IaC (Infrastructure as Code)** ä¸€å¼ã§ã™ã€‚

## ğŸ§­ Architecture

![Architecture Diagram](./image/ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³.png)

## ğŸ”¢ Version

| Name | Version |
|---|---|
| Terraform | v1.13.3 |
| Terragrunt | v0.87.3 |
| Lint/Sec | tflint, trivy |
| Git hooks | pre-commitï¼ˆfmt / validate / tflint / trivy / docsï¼‰ |

## ğŸ“‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
terraform
â”œâ”€â”€ organization # <--- Organization entrypoint(management account)
â”‚    â”œâ”€â”€ organizations 
â”‚    â”‚   â”œâ”€â”€ policies 
â”‚    â”‚   â””â”€â”€ sso 
â”‚    â””â”€â”€ state_backend
â”‚ 
â”œâ”€â”€ envs
â”‚   â”œâ”€â”€ dev
â”‚   â””â”€â”€ prod
â”‚       â”œâ”€â”€ env.hcl
â”‚       â”œâ”€â”€ network # <--- Network account entrypoint
â”‚       â”‚   â”œâ”€â”€ ec2 
â”‚       â”‚   â”œâ”€â”€ endpoint 
â”‚       â”‚   â”œâ”€â”€ tgw_attachment 
â”‚       â”‚   â”œâ”€â”€ tgw_hub 
â”‚       â”‚   â”œâ”€â”€ tgw_route 
â”‚       â”‚   â”œâ”€â”€ vpc 
â”‚       â”‚   â””â”€â”€ vpc_route_to_tgw 
â”‚       â”‚ 
â”‚       â””â”€â”€ workloads # <--- Workload account entrypoint
â”‚           â”œâ”€â”€ alb 
â”‚           â”œâ”€â”€ app 
â”‚           â”œâ”€â”€ dns 
â”‚           â”œâ”€â”€ ecr 
â”‚           â”œâ”€â”€ network
â”‚           â”‚   â”œâ”€â”€ endpoint
â”‚           â”‚   â”œâ”€â”€ tgw_attachment
â”‚           â”‚   â”œâ”€â”€ tgw_hub
â”‚           â”‚   â”œâ”€â”€ vpc
â”‚           â”‚   â””â”€â”€ vpc_route_to_tgw
â”‚           â””â”€â”€ postgres 
â”‚ 
â”œâ”€â”€ modules # <--- modules
â”‚   â”œâ”€â”€ compute 
â”‚   â”‚   â”œâ”€â”€ ec2_bastion 
â”‚   â”‚   â”œâ”€â”€ ecr 
â”‚   â”‚   â””â”€â”€ ecs_fargate 
â”‚   â”œâ”€â”€ grobal 
â”‚   â”‚   â”œâ”€â”€ oidc 
â”‚   â”‚   â”œâ”€â”€ organizations
â”‚   â”‚   â””â”€â”€ scp 
â”‚   â”œâ”€â”€ network
â”‚   â”‚   â”œâ”€â”€ alb_waf
â”‚   â”‚   â”œâ”€â”€ endpoint 
â”‚   â”‚   â”œâ”€â”€ route53_private_zone 
â”‚   â”‚   â”œâ”€â”€ tgw_hub 
â”‚   â”‚   â”œâ”€â”€ tgw_route 
â”‚   â”‚   â”œâ”€â”€ tgw_vpc_attachment 
â”‚   â”‚   â”œâ”€â”€ tgw_vpc_attachment_accepter
â”‚   â”‚   â”œâ”€â”€ vpc # VPCãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â””â”€â”€ vpc_route_to_tgw 
â”‚   â””â”€â”€ storage 
â”‚       â”œâ”€â”€ backend 
â”‚       â””â”€â”€ rds 
â”‚
```

## â˜ï¸ AWS Organization ã‹ã‚‰ã®å®Œå…¨ IaC åŒ–
![SSO Setup](./image/Organization.png)
ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç’°å¢ƒã‚’æ¨¡å€£ã—ã€ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¾ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰çµ„ç¹”å˜ä½ã®ç®¡ç†ã¾ã§ **Terraform ã§ä¸€å…ƒç®¡ç†** å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚

**SSO (Single Sign-On)** ã‚‚ Terraform ã§æœ‰åŠ¹åŒ–ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

![SSO Setup](./image/sso.png)

## ğŸ§© DRY åŸå‰‡ã®å¾¹åº•

**Terragrunt** ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§ã€`input` ã«å€¤ã‚’æ¸¡ã™ã ã‘ã§æ§‹ç¯‰å¯èƒ½ãªã€ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å†åˆ©ç”¨æ€§ã®é«˜ã„ IaC ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

`env.hcl` ã®å€¤ã‚’ä¿®æ­£ã™ã‚‹ã ã‘ã§ã€`prod` / `dev` ç’°å¢ƒã®åˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½ã§ã™ã€‚

`terragrunt plan -all` ã‚’å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã€ã™ã¹ã¦ã® AWS ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ãªãã¦ã‚‚ `plan` ãŒé€šã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚

![Terragrunt Plan](./image/plan.png)

## ğŸ”’ å®Œå…¨é–‰åŸŸç¶² AWS ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

**Transit Gateway** ã‚’åˆ©ç”¨ã—ã€è¤‡æ•° VPC ã®æ‹¡å¼µã«å¯¾å¿œå¯èƒ½ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã§ã™ã€‚
**VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ** ã‚’æ´»ç”¨ã—ã¦å®Œå…¨é–‰åŸŸç¶²ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚
ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹é€£æºã‚’æƒ³å®šã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« **Inbound/Outbound Resolver** ã‚’é…ç½®ã™ã‚‹ã“ã¨ã§ã€åŒæ–¹å‘ã®åå‰è§£æ±ºã‚’å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚

### ğŸ’¡ æƒ³å®šã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼

- **é‡‘èæ©Ÿé–¢ / å…¬å…±ç³»ã‚·ã‚¹ãƒ†ãƒ :** é–‰åŸŸç¶²ã§å€‹äººæƒ…å ±ã‚’æ‰±ã„ã€å¤–éƒ¨å…¬é–‹ã›ãšã« VPN / å°‚ç”¨ç·šçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚±ãƒ¼ã‚¹ã€‚
- **ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã®ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ :** ç¤¾å“¡å°‚ç”¨ã®äººäº‹ãƒ»çµŒç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¬é–‹ãŒä¸è¦ã§ç¤¾å†… VPN ã®ã¿ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚±ãƒ¼ã‚¹ã€‚
- **è£½é€ æ¥­ / åŒ»ç™‚åˆ†é‡ã®ç ”ç©¶ã‚·ã‚¹ãƒ†ãƒ :** æ©Ÿå¯†è¨­è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚é–‰åŸŸåŒ–ã—ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹é€£æºã‚‚å®¹æ˜“ã«è¡Œã„ãŸã„ã‚±ãƒ¼ã‚¹ã€‚

## ğŸ“Š ã‚³ã‚¹ãƒˆåˆ†æ
ç®¡ç†ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ **Cost Export** ã¨ **QuickSight** ã‚’æœ‰åŠ¹åŒ–ã—ã€å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚³ã‚¹ãƒˆåˆ†æã‚’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä¸€å…ƒç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

![Cost Dashboard](./image/costdashboad.png)

ã¾ãŸã€**Athena** ã«ã‚ˆã‚‹è©³ç´°ãªã‚¯ã‚¨ãƒªã‚‚å¯èƒ½ã§ã™ã€‚

![Athena Query](./image/athena.png)

## âš™ï¸ pre-commit ã«ã‚ˆã‚‹ CI

å½“åˆã¯ GitHub Actions ã§ CI ã‚’å›ã—ã¦ã„ã¾ã—ãŸãŒã€é–‹ç™ºåŠ¹ç‡ã‚’è€ƒæ…®ã—ã€ç¾åœ¨ã¯ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ **pre-commit** ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ãŸæ§‹æˆã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚

![Pre-commit CI](./image/pre-commit.png)

## qiita
https://qiita.com/rt-art/items/c54d0cea114c0ee72122

https://qiita.com/rt-art/items/c6364d90b1546e92db57

https://qiita.com/rt-art/items/2d30cf249bab75bf73f9

https://qiita.com/rt-art/items/4153e5673a18cb487d6d

## ğŸ—ºï¸ ä»Šå¾Œã®æ‹¡å¼µï¼ˆTODOï¼‰

- **GitHub Actions ã§ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‹•ä½œå¯èƒ½ãªå·®åˆ†é§†å‹•ã® plan/tfsec:** (OIDC ã¯å®Ÿè£…æ¸ˆã¿)
- **RDS ç§˜å¯†æƒ…å ±ã® Secrets Manager é€£æº**

