<div align="center">

# Minimal Gov

</div>
â­ **AWS Ã— Terraform Ã— Terragrunt**

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€å®Ÿå‹™ã§è§¦ã‚Œã¦ã„ãŸç’°å¢ƒã‚’å¯èƒ½ãªé™ã‚Šæ¨¡å€£ã—ã€å€‹äººãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã¨ã—ã¦æ§‹ç¯‰ã—ãŸ **IaC (Infrastructure as Code)** ä¸€å¼ã§ã™ã€‚

## ğŸ§­ Architecture

![Architecture Diagram](./image/ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³.png)

Transit Gateway ã‚’ãƒãƒ–ã¨ã—ã¦ `network` (å…±é€š NW) ã¨ `workloads` (æ¥­å‹™ VPC) ã‚’æ¥ç¶šã™ã‚‹æ§‹æˆã§ã™ã€‚
ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰å´ã¯ **ALB + WAF** â†’ **ECS(Fargate)** / **RDS(PostgreSQL)** / **PrivateHostZone** ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

## ğŸ”¢ Version

| Name | Version |
|---|---|
| Terraform | v1.13.3 |
| Terragrunt | v0.87.3 |
| Lint/Sec | tflint, trivy |
| Git hooks | pre-commitï¼ˆfmt / validate / tflint / trivy / docsï¼‰ |

## ğŸ“‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
terraform
â”œâ”€â”€ envs
â”‚   â”œâ”€â”€ dev
â”‚   â””â”€â”€ prod
â”‚       â”œâ”€â”€ env.hcl
â”‚       â”œâ”€â”€ network # <--- Network account entrypoint
â”‚       â”‚   â”œâ”€â”€ ec2 
â”‚       â”‚   â”œâ”€â”€ endpoint 
â”‚       â”‚   â”œâ”€â”€ tgw_attachment 
â”‚       â”‚   â”œâ”€â”€ tgw_hub 
â”‚       â”‚   â”œâ”€â”€ tgw_route 
â”‚       â”‚   â”œâ”€â”€ vpc 
â”‚       â”‚   â””â”€â”€ vpc_route_to_tgw 
â”‚       â”‚ 
â”‚       â””â”€â”€ workloads # <--- Workload account entrypoint
â”‚           â”œâ”€â”€ alb 
â”‚           â”œâ”€â”€ app 
â”‚           â”œâ”€â”€ dns 
â”‚           â”œâ”€â”€ ecr 
â”‚           â”œâ”€â”€ network
â”‚           â”‚   â”œâ”€â”€ endpoint
â”‚           â”‚   â”œâ”€â”€ tgw_attachment
â”‚           â”‚   â”œâ”€â”€ tgw_hub
â”‚           â”‚   â”œâ”€â”€ vpc
â”‚           â”‚   â””â”€â”€ vpc_route_to_tgw
â”‚           â””â”€â”€ postgres 
â”‚ 
â”œâ”€â”€ modules
â”‚   â”œâ”€â”€ compute 
â”‚   â”‚   â”œâ”€â”€ ec2_bastion 
â”‚   â”‚   â”œâ”€â”€ ecr 
â”‚   â”‚   â””â”€â”€ ecs_fargate 
â”‚   â”œâ”€â”€ grobal 
â”‚   â”‚   â”œâ”€â”€ oidc 
â”‚   â”‚   â”œâ”€â”€ organizations
â”‚   â”‚   â””â”€â”€ scp 
â”‚   â”œâ”€â”€ network
â”‚   â”‚   â”œâ”€â”€ alb_waf
â”‚   â”‚   â”œâ”€â”€ endpoint 
â”‚   â”‚   â”œâ”€â”€ route53_private_zone 
â”‚   â”‚   â”œâ”€â”€ tgw_hub 
â”‚   â”‚   â”œâ”€â”€ tgw_route 
â”‚   â”‚   â”œâ”€â”€ tgw_vpc_attachment 
â”‚   â”‚   â”œâ”€â”€ tgw_vpc_attachment_accepter
â”‚   â”‚   â”œâ”€â”€ vpc # VPCãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â””â”€â”€ vpc_route_to_tgw 
â”‚   â””â”€â”€ storage 
â”‚       â”œâ”€â”€ backend 
â”‚       â””â”€â”€ rds 
â”‚
â””â”€â”€ organization # <--- Organization entrypoint(management account)
    â”œâ”€â”€ organizations 
    â”‚   â”œâ”€â”€ policies 
    â”‚   â””â”€â”€ sso 
    â””â”€â”€ state_backend

```

## â˜ï¸ AWS Organization ã‹ã‚‰ã®å®Œå…¨ IaC åŒ–

ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç’°å¢ƒã‚’æ¨¡å€£ã—ã€ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¾ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰çµ„ç¹”å˜ä½ã®ç®¡ç†ã¾ã§ **Terraform ã§ä¸€å…ƒç®¡ç†** å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚

**SSO (Single Sign-On)** ã‚‚ Terraform ã§æœ‰åŠ¹åŒ–ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

![SSO Setup](./image/sso.png)

## ğŸ§© DRY åŸå‰‡ã®å¾¹åº•

**Terragrunt ã® DRY & Facade ãƒ‘ã‚¿ãƒ¼ãƒ³** ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§ã€`input` ã«å€¤ã‚’æ¸¡ã™ã ã‘ã§æ§‹ç¯‰å¯èƒ½ãªã€ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å†åˆ©ç”¨æ€§ã®é«˜ã„ IaC ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

`env.hcl` ã®å€¤ã‚’ä¿®æ­£ã™ã‚‹ã ã‘ã§ã€`prod` / `dev` ç’°å¢ƒã®åˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½ã§ã™ã€‚

`terragrunt plan -all` ã‚’å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã€ã™ã¹ã¦ã® AWS ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ãªãã¦ã‚‚ `plan` ãŒé€šã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚

![Terragrunt Plan](./image/plan.png)

## ğŸ”’ å®Œå…¨é–‰åŸŸç¶² AWS ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

**Transit Gateway** ã‚’åˆ©ç”¨ã—ã€è¤‡æ•° VPC ã®æ‹¡å¼µã«å¯¾å¿œå¯èƒ½ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã§ã™ã€‚
**VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ** ã‚’æ´»ç”¨ã—ã¦å®Œå…¨é–‰åŸŸç¶²ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚
ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹é€£æºã‚’æƒ³å®šã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« **Inbound/Outbound Resolver** ã‚’é…ç½®ã™ã‚‹ã“ã¨ã§ã€åŒæ–¹å‘ã®åå‰è§£æ±ºã‚’å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚

### ğŸ’¡ æƒ³å®šã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼

- **é‡‘èæ©Ÿé–¢ / å…¬å…±ç³»ã‚·ã‚¹ãƒ†ãƒ :** é–‰åŸŸç¶²ã§å€‹äººæƒ…å ±ã‚’æ‰±ã„ã€å¤–éƒ¨å…¬é–‹ã›ãšã« VPN / å°‚ç”¨ç·šçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚±ãƒ¼ã‚¹ã€‚
- **ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã®ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ :** ç¤¾å“¡å°‚ç”¨ã®äººäº‹ãƒ»çµŒç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¬é–‹ãŒä¸è¦ã§ç¤¾å†… VPN ã®ã¿ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚±ãƒ¼ã‚¹ã€‚
- **è£½é€ æ¥­ / åŒ»ç™‚åˆ†é‡ã®ç ”ç©¶ã‚·ã‚¹ãƒ†ãƒ :** æ©Ÿå¯†è¨­è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚é–‰åŸŸåŒ–ã—ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹é€£æºã‚‚å®¹æ˜“ã«è¡Œã„ãŸã„ã‚±ãƒ¼ã‚¹ã€‚

## ğŸ“Š ã‚³ã‚¹ãƒˆåˆ†æ
ç®¡ç†ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ **Cost Export** ã¨ **QuickSight** ã‚’æœ‰åŠ¹åŒ–ã—ã€å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚³ã‚¹ãƒˆåˆ†æã‚’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä¸€å…ƒç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

![Cost Dashboard](./image/costdashboad.png)

ã¾ãŸã€**Athena** ã«ã‚ˆã‚‹è©³ç´°ãªã‚¯ã‚¨ãƒªã‚‚å¯èƒ½ã§ã™ã€‚

![Athena Query](./image/athena.png)

## âš™ï¸ pre-commit ã«ã‚ˆã‚‹ CI

å½“åˆã¯ GitHub Actions ã§ CI ã‚’å›ã—ã¦ã„ã¾ã—ãŸãŒã€é–‹ç™ºåŠ¹ç‡ã‚’è€ƒæ…®ã—ã€ç¾åœ¨ã¯ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ **pre-commit** ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ãŸæ§‹æˆã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚

![Pre-commit CI](./image/pre-commit.png)

## ğŸš€ Quick Start

### å‰æ

- AWS è³‡æ ¼æƒ…å ±ï¼ˆ`AWS_PROFILE` ã¾ãŸã¯ `~/.aws/credentials`ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚
- Terraform v1.13.3 ãŠã‚ˆã³ Terragrunt v0.87.3 ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã€‚

### åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (pre-commit)

åˆå›åˆ©ç”¨æ™‚ã«ã¯ `pre-commit` ã‚’å°å…¥ã—ã€ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ã€‚

```bash
pipx install pre-commit # ã‚‚ã—ãã¯ venv + pip
pre-commit install
pre-commit run --all-files # å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
```

### Plan ã®å®Ÿè¡Œ (Applyã¯æ–™é‡‘ç™ºç”Ÿã«æ³¨æ„)

å„ `terragrunt.hcl` ã® `input` ã‚’ç·¨é›†ã—ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```bash
cd infra/envs/prod

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é ˜åŸŸ (é †åºåˆ¶å¾¡ã—ã‚„ã™ã„ã‚ˆã†å€‹åˆ¥/ä¸€æ‹¬ã©ã¡ã‚‰ã‚‚å®Ÿè¡Œå¯èƒ½)
terragrunt run-all plan -include-dir network

# ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰é ˜åŸŸ
terragrunt run-all plan -include-dir workloads
```

## ğŸ—ºï¸ ä»Šå¾Œã®æ‹¡å¼µï¼ˆTODOï¼‰

- **GitHub Actions ã§ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‹•ä½œå¯èƒ½ãªå·®åˆ†é§†å‹•ã® plan/tfsec:** (OIDC ã¯å®Ÿè£…æ¸ˆã¿)
- **RDS ç§˜å¯†æƒ…å ±ã® Secrets Manager é€£æº**


---

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªãŒã€çš†æ§˜ã® IaC æ§‹ç¯‰ã®ä¸€åŠ©ã¨ãªã‚Œã°å¹¸ã„ã§ã™ã€‚ã”æ„è¦‹ã‚„ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚æ­“è¿ã„ãŸã—ã¾ã™ã€‚

